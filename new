import serial
import time

# --- CONFIGURATION ---
GSM_SERIAL_PORT = "/dev/serial0" # Standard UART on GPIO 14/15
GSM_BAUDRATE = 9600
TARGET_PHONE_NUMBER = "+91xxxxxxxxxx" # REPLACE with a real number for testing SMS

# --- MAIN LOGIC ---

def send_command(ser, command, wait_time=1):
    """Sends an AT command and reads the response."""
    # Clear any old data
    ser.read_all()
    
    # Send command (must be encoded and include carriage return)
    ser.write((command + '\r\n').encode('utf-8'))
    time.sleep(wait_time)
    
    # Read response
    response = ser.read_all().decode('utf-8', errors='ignore').strip()
    return response

def gsm_test():
    print("--- GSM Module Connectivity Test ---")
    
    try:
        # Open the serial port
        with serial.Serial(GSM_SERIAL_PORT, GSM_BAUDRATE, timeout=5) as ser:
            print(f"Connected to {GSM_SERIAL_PORT} at {GSM_BAUDRATE} baud.")
            time.sleep(1)

            # 1. Basic AT Command Test
            print("\n1. Testing basic communication (AT)...")
            response = send_command(ser, "AT", 1)
            
            if "OK" in response:
                print("✅ Module Responded: Communication is OK.")
            else:
                print(f"❌ ERROR: No response or invalid response.")
                print("   Check power, wiring, and ensure 9600 baud rate.")
                return

            # 2. Check Network Registration
            print("\n2. Checking network registration (AT+CREG)...")
            response = send_command(ser, "AT+CREG?", 2)
            
            # Expected response: +CREG: X,Y where Y=1 (Registered, home network) or Y=5 (Registered, roaming)
            if ",1" in response or ",5" in response:
                print("✅ Network Status: Registered (Ready to send SMS/Calls).")
            else:
                print("⚠️ Network Status: Not fully registered (Searching or Denied).")
                print("   Check SIM card, antenna, and signal coverage.")
                print(f"   Raw response: {response}")

            # 3. Check Signal Quality
            print("\n3. Checking signal quality (AT+CSQ)...")
            response = send_command(ser, "AT+CSQ", 1)
            
            if "+CSQ:" in response:
                # Example: +CSQ: 18,0 (18 is good signal)
                rssi_value = response.split(':')[1].split(',')[0].strip()
                print(f"✅ Signal Quality: RSSI = {rssi_value}")
                if int(rssi_value) < 10 or int(rssi_value) == 99:
                     print("   WARNING: Signal is weak. Move module closer to a window.")
            else:
                print("⚠️ Could not read signal quality.")

            # 4. SMS Sending Test (Requires successful registration)
            if ",1" in response or ",5" in response: # Check if network registered
                print(f"\n4. Testing SMS sending to {TARGET_PHONE_NUMBER}...")
                
                # Set to Text Mode
                send_command(ser, "AT+CMGF=1", 1)
                
                # Set target number
                ser.write(f'AT+CMGS="{TARGET_PHONE_NUMBER}"\r\n'.encode('utf-8'))
                time.sleep(1)
                
                # Send message text
                message = "GSM Test OK from Raspberry Pi."
                ser.write(message.encode('utf-8'))
                
                # Send Ctrl+Z (ASCII 26) to signal end of message
                ser.write(bytes([26])) 
                time.sleep(5)
                
                sms_response = ser.read_all().decode('utf-8', errors='ignore').strip()
                
                if "OK" in sms_response or "+CMGS" in sms_response:
                    print("✅ SMS Test: Message successfully sent.")
                else:
                    print(f"❌ SMS Test: Failed to send message. Raw response: {sms_response}")


    except serial.SerialException as e:
        print(f"\nFATAL ERROR: Could not open serial port {GSM_SERIAL_PORT}.")
        print("1. Ensure your GSM module is wired to GPIO 14/15.")
        print("2. Ensure you disabled the Serial Console in raspi-config.")
        print(f"Error details: {e}")
    except Exception as e:
        print(f"\nAn unexpected error occurred: {e}")

if __name__ == "__main__":
    gsm_test()
